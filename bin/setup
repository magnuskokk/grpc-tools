#!/bin/bash
set -Eeuo pipefail
trap "echo ERR trap fired!" ERR

PROTOC_VERSION=3.9.0
PROTOC_GEN_GRPC_WEB_VERSION=1.0.5

mkdir -p $GOPATH

echo -e "\033[1;37mInstalling protoc...\033[0m"
wget -qO- https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-x86_64.zip | bsdtar -xvf- -C $GOPATH

echo -e "\033[1;37mInstalling protoc-gen-grpc-web...\033[0m"
wget -O $GOPATH/bin/protoc-gen-grpc-web https://github.com/grpc/grpc-web/releases/download/1.0.5/protoc-gen-grpc-web-${PROTOC_GEN_GRPC_WEB_VERSION}-linux-x86_64
chmod +x $GOPATH/bin/protoc-gen-grpc-web

echo -e "\033[1;37mInstalling go development dependencies...\033[0m"

# Need raw sources to include .proto files from $GOPATH/src
GO111MODULE=off go get -u -v github.com/gogo/googleapis/...
GO111MODULE=off go get -u -v github.com/grpc-ecosystem/grpc-gateway/...
GO111MODULE=off go get -u -v github.com/mwitkow/go-proto-validators/...

GO111MODULE=on go get -u -v \
    github.com/gogo/protobuf/protoc-gen-gogo \
    github.com/grpc-ecosystem/grpc-gateway/protoc-gen-grpc-gateway \
    github.com/grpc-ecosystem/grpc-gateway/protoc-gen-swagger \
    github.com/mwitkow/go-proto-validators/protoc-gen-govalidators \
    github.com/rakyll/statik

npm install
cp -r ./node_modules/swagger-ui-dist/ ./swagger/