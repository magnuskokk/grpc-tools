options:
  user:
    usage: Username to use for base images.
    default:
      command: id -un
  group:
    usage: Group name to use for base images.
    default:
      command: id -gn
  uid:
    usage: User id to use for base images.
    default:
      command: id -u
  gid:
    usage: User group id to use for base images.
    default:
      command: id -g

tasks:
  docker.down:
    usage: Stop all containers.
    run:
      - command: docker-compose -f docker-compose.dev.yml down
      - command: docker-compose down

  docker.cleancontainers:
    usage: Remove all local containers, images and any anonymous volumes attached to containers.
    run:
      - command: docker-compose -f docker-compose.dev.yml rm --stop --force -v
      - command: docker-compose rm --stop --force -v

  docker.cleanimages:
    usage: Stop all containers and remove all images used by any defined services.
    run:
      - command: docker-compose -f docker-compose.dev.yml down --rmi all
      - command: docker-compose down --rmi all

  docker.cleanvolumes:
    usage: Stop and clean all local volumes.
    run:
      - command: docker-compose -f docker-compose.dev.yml down -v
      - command: docker-compose down -v

  docker.cleanall:
    usage: Clean all all docker stuff for services.
    run:
      - task: docker.cleancontainers
      - task: docker.cleanimages
      - task: docker.cleanvolumes

  env.clean:
    usage: Clean the environment including docker containers but keep images and named volumes.
    run:
      - task: docker.cleancontainers
      - command: rm -rf ./.direnv

  env.build:
    usage: Build the docker containers for dev tools.
    description: Called by setup.sh.
    run:
      command: >
        docker-compose -f docker-compose.dev.yml build
        --force-rm
        --build-arg USER=${user}
        --build-arg GROUP=${group}
        --build-arg UID=${uid}
        --build-arg GID=${gid}

  env.reset:
    usage: Reset and rebuild the dev environment.
    run:
      - task: env.clean
      - command: sh setup.sh

  env.install.tools:
    usage: Install tools and dependencies for generating code.
    description: Downloads a lot of packages.
    run:
      - command: docker-compose -f docker-compose.dev.yml up -d golocal
      - command: docker-compose -f docker-compose.dev.yml exec golocal tusk install.tools
      - command: docker-compose -f docker-compose.dev.yml exec golocal tusk install.proto.wkt

  gen.protolint:
    usage: Lint protobuf definitions using prototool.
    run:
      command: >
        docker-compose -f docker-compose.dev.yml run --rm -u ${uid}:${gid} prototool
        prototool lint

  gen.protoc:
    usage: Generate gRPC server, client, gateway, typescript and swagger for all services.
    run:
      command: >
        docker-compose -f docker-compose.dev.yml run --rm -u ${uid}:${gid} prototool
        prototool generate

  gen.go:
    usage: Run all //go:generate directives.
    run:
      - command: docker-compose -f docker-compose.dev.yml up -d golocal
      - command: docker-compose -f docker-compose.dev.yml exec golocal tusk generate

  gen.clean:
    usage: Remove all generated files.
    run:
      - command: tusk -f ./app/tusk.yml clean
      - command: tusk -f ./frontend/tusk.yml clean
      - command: tusk -f ./swagger/tusk.yml clean

  app.test:
    usage: Run all go tests.
    description: |
      Test
    run:
      - command: docker-compose -f docker-compose.dev.yml up -d golocal
      - command: docker-compose -f docker-compose.dev.yml exec golocal tusk test

  app.bench:
    usage: Run all go benchmarks.
    run:
      - command: docker-compose -f docker-compose.dev.yml up -d golocal
      - command: docker-compose -f docker-compose.dev.yml exec golocal tusk bench

  monitor.grafana:
    usage: Start Grafana.
    description: at localhost:3000
    run:
      - command: docker-compose -f docker-compose.yml up grafana

  stack.build:
    usage: Build stack.
    run:
      - command: >
          docker-compose -f docker-compose.dev.yml build
          --force-rm
          --build-arg USER=${user}
          --build-arg GROUP=${group}
          --build-arg UID=${uid}
          --build-arg GID=${gid}
          gobuild
      - command: >
          docker-compose build
          --force-rm
          --parallel
          --build-arg USER=${user}
          --build-arg GROUP=${group}
          --build-arg UID=${uid}
          --build-arg GID=${gid}
          echo-server
          raspi-server
          metrics-server

  stack.up:
    usage: Start the stack.
    run:
      - command: docker-compose up -d

  stack.down:
    usage: Stop the stack.
    run:
      - command: docker-compose down
