options:
  user:
    usage: Username to use for base images.
    default:
      command: id -un
  uid:
    usage: User id to use for base images.
    default:
      command: id -u 
  gid:
    usage: User group id to use for base images.
    default:
      command: id -g

tasks:
  build-dev-tools:
    usage: Build the docker containers for tools.
    run:
      command: >
        docker-compose -f docker-compose.tools.yml build
        --force-rm
        --parallel
        --build-arg USER=${user}
        --build-arg UID=${uid}
        --build-arg GID=${gid}

  install-dev-deps:
    usage: Install development tools.
    run:
      - command: docker-compose -f docker-compose.tools.yml up -d gobase
      - command: docker-compose -f docker-compose.tools.yml exec gobase tusk install-proto-wkt
      - command: docker-compose -f docker-compose.tools.yml exec gobase tusk install-dev-deps

  protolint:
    usage: Lint protobuf defnitions using prototool.
    run:
      command: >
        docker-compose -f docker-compose.tools.yml run --rm -u ${uid}:${gid} prototool
        prototool lint

  protoc:
    usage: Generate gRPC server, client, gateway, typescript and swagger for all services.
    run:
      command: >
        docker-compose -f docker-compose.tools.yml run --rm -u ${uid}:${gid} prototool
        prototool generate

  generate.go:
    usage: Run all //go:generate directives.
    run:
      - command: docker-compose -f docker-compose.tools.yml up -d gobase
      - command: docker-compose -f docker-compose.tools.yml exec gobase tusk generate

  test.go:
    usage: Run all go tests.
    description: |
      Test
    run:
      - command: docker-compose -f docker-compose.tools.yml up -d gobase
      - command: docker-compose -f docker-compose.tools.yml exec gobase tusk test

  bench.go:
    usage: Run all go benchmarks.
    run:
      - command: docker-compose -f docker-compose.tools.yml up -d gobase
      - command: docker-compose -f docker-compose.tools.yml exec gobase tusk bench

  clean:
    usage: Remove all generated files.
    run:
      - command: tusk -f ./app/tusk.yml clean
      - command: tusk -f ./frontend/tusk.yml clean
      - command: tusk -f ./swagger/tusk.yml clean
    
  dockerclean:
    usage: Reset docker
    run:
      - command: docker-compose -f docker-compose.tools.yml down --remove-orphans
      - command: docker-compose down --remove-orphans
      - command: docker system prune --volumes -a

  envclean:
    usage: Reset the dev environment.
    description: Removes .direnv and all docker stuff globally on the system.
    run:
      - task: dockerclean
      - command: sudo rm -rf ./.direnv

  serve.echo.dev:
    usage: Start the echo service server in a fresh container by using docker-compose run.
    description: Useful for quick development. TODO set some env variables to print extra debug logs orsmth.
    run:
      command: >
        docker-compose -f docker-compose.tools.yml run
        --rm
        -u ${uid}:${gid}
        -v "${pwd}/app:/app"
        -v "${pwd}/.direnv:/go"
        -p 8000:8000
        gobase
        go run cmd/echo-server/main.go

  serve.echo.prod:
    usage: Start the echo service server by using compiled and packaged container.
    description: Run the final production image.
    run:
      command: docker-compose up echo-server

  serve.echo.swagger:
    usage: Start the swagger UI
    run:
      command: >
        docker-compose -f docker-compose.tools.yml run --rm --service-ports echo-swagger
