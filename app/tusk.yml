tasks:
  install:
    usage: Compile and install go services to $GOPATH/bin.
    run:
      command: go install -v ./...

  install.proto.wkt:
    usage: Install Well-Known Types and various other .proto sources.
    run:
      - set-environment:
          GO111MODULE: off
      - command: >
          go get -v
          github.com/gogo/protobuf/...
          github.com/gogo/googleapis/...
          github.com/grpc-ecosystem/grpc-gateway/...

  install.dev:
    usage: Install go dev deps
    run:
      - task: install.proto.wkt
      - set-environment:
          GO111MODULE: on
      - command: go get -v golang.org/x/tools/go/packages
      - command: go get -v github.com/golang/mock/gomock
      - command: go install -v github.com/golang/mock/mockgen

  generate:
    usage: Run //go:generate directives.
    description: |
      This is currently used for generating mocks.
    run:
      command: go generate -x ./...

  clean:
    usage: Remove all generated go files.
    run:
      - command: rm -rf ./idl
      - command: find . -type d -name "mocks" -exec rm -rf {} +

  test:
    usage: Run all go tests.
    run:
      command: go test -count=1 -v ./...

  bench:
    usage: Run all go benchmarks.
    run:
      command: go test -run=xxx -bench=. ./...

  serve.echo.dev:
    usage: Run the echo server locally.
    run:
      command: go run cmd/echo-server/main.go
